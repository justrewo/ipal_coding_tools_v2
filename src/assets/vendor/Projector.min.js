THREE.RenderableObject=function(){this.id=0;this.object=null;this.z=0;this.renderOrder=0};THREE.RenderableFace=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.v3=new THREE.RenderableVertex;this.normalModel=new THREE.Vector3;this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];this.vertexNormalsLength=0;this.color=new THREE.Color;this.material=null;this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2];this.z=0;this.renderOrder=0};THREE.RenderableVertex=function(){this.position=new THREE.Vector3;this.positionWorld=new THREE.Vector3;this.positionScreen=new THREE.Vector4;this.visible=true};THREE.RenderableVertex.prototype.copy=function(e){this.positionWorld.copy(e.positionWorld);this.positionScreen.copy(e.positionScreen)};THREE.RenderableLine=function(){this.id=0;this.v1=new THREE.RenderableVertex;this.v2=new THREE.RenderableVertex;this.vertexColors=[new THREE.Color,new THREE.Color];this.material=null;this.z=0;this.renderOrder=0};THREE.RenderableSprite=function(){this.id=0;this.object=null;this.x=0;this.y=0;this.z=0;this.rotation=0;this.scale=new THREE.Vector2;this.material=null;this.renderOrder=0};THREE.Projector=function(){var e,r,t=[],i=0,n,o,a=[],s=0,l,c,p=[],u=0,f,E,v=[],d=0,h,m,y=[],x=0,R={objects:[],lights:[],elements:[]},T=new THREE.Vector3,H=new THREE.Vector4,g=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),w=new THREE.Box3,S=new Array(3),M=new THREE.Matrix4,b=new THREE.Matrix4,z,V=new THREE.Matrix4,j=new THREE.Matrix3,O=new THREE.Frustum,C=new THREE.Vector4,L=new THREE.Vector4;this.projectVector=function(e,r){console.warn("THREE.Projector: .projectVector() is now vector.project().");e.project(r)};this.unprojectVector=function(e,r){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject().");e.unproject(r)};this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")};var k=function(){var e=[];var r=[];var t=[];var i=null;var o=null;var s=new THREE.Matrix3;function c(n){i=n;o=i.material;s.getNormalMatrix(i.matrixWorld);e.length=0;r.length=0;t.length=0}function p(e){var r=e.position;var t=e.positionWorld;var i=e.positionScreen;t.copy(r).applyMatrix4(z);i.copy(t).applyMatrix4(b);var n=1/i.w;i.x*=n;i.y*=n;i.z*=n;e.visible=i.x>=-1&&i.x<=1&&i.y>=-1&&i.y<=1&&i.z>=-1&&i.z<=1}function u(e,r,t){n=P();n.position.set(e,r,t);p(n)}function E(r,t,i){e.push(r,t,i)}function v(e,t,i){r.push(e,t,i)}function d(e,r){t.push(e,r)}function h(e,r,t){if(e.visible===true||r.visible===true||t.visible===true)return true;S[0]=e.positionScreen;S[1]=r.positionScreen;S[2]=t.positionScreen;return g.intersectsBox(w.setFromPoints(S))}function m(e,r,t){return(t.positionScreen.x-e.positionScreen.x)*(r.positionScreen.y-e.positionScreen.y)-(t.positionScreen.y-e.positionScreen.y)*(r.positionScreen.x-e.positionScreen.x)<0}function y(e,t){var n=a[e];var o=a[t];n.positionScreen.copy(n.position).applyMatrix4(V);o.positionScreen.copy(o.position).applyMatrix4(V);if(q(n.positionScreen,o.positionScreen)===true){n.positionScreen.multiplyScalar(1/n.positionScreen.w);o.positionScreen.multiplyScalar(1/o.positionScreen.w);f=D();f.id=i.id;f.v1.copy(n);f.v2.copy(o);f.z=Math.max(n.positionScreen.z,o.positionScreen.z);f.renderOrder=i.renderOrder;f.material=i.material;if(i.material.vertexColors===THREE.VertexColors){f.vertexColors[0].fromArray(r,e*3);f.vertexColors[1].fromArray(r,t*3)}R.elements.push(f)}}function x(r,n,c){var p=a[r];var u=a[n];var f=a[c];if(h(p,u,f)===false)return;if(o.side===THREE.DoubleSide||m(p,u,f)===true){l=G();l.id=i.id;l.v1.copy(p);l.v2.copy(u);l.v3.copy(f);l.z=(p.positionScreen.z+u.positionScreen.z+f.positionScreen.z)/3;l.renderOrder=i.renderOrder;l.normalModel.fromArray(e,r*3);l.normalModel.applyMatrix3(s).normalize();for(var E=0;E<3;E++){var v=l.vertexNormalsModel[E];v.fromArray(e,arguments[E]*3);v.applyMatrix3(s).normalize();var d=l.uvs[E];d.fromArray(t,arguments[E]*2)}l.vertexNormalsLength=3;l.material=i.material;R.elements.push(l)}}return{setObject:c,projectVertex:p,checkTriangleVisibility:h,checkBackfaceCulling:m,pushVertex:u,pushNormal:E,pushColor:v,pushUv:d,pushLine:y,pushTriangle:x}};var B=new k;function N(e){if(e.visible===false)return;if(e instanceof THREE.Light){R.lights.push(e)}else if(e instanceof THREE.Mesh||e instanceof THREE.Line||e instanceof THREE.Points){if(e.material.visible===false)return;if(e.frustumCulled===true&&O.intersectsObject(e)===false)return;W(e)}else if(e instanceof THREE.Sprite){if(e.material.visible===false)return;if(e.frustumCulled===true&&O.intersectsSprite(e)===false)return;W(e)}var r=e.children;for(var t=0,i=r.length;t<i;t++){N(r[t])}}function W(r){e=F();e.id=r.id;e.object=r;T.setFromMatrixPosition(r.matrixWorld);T.applyMatrix4(b);e.z=T.z;e.renderOrder=r.renderOrder;R.objects.push(e)}this.projectScene=function(e,t,i,n){c=0;E=0;m=0;R.elements.length=0;if(e.autoUpdate===true)e.updateMatrixWorld();if(t.parent===null)t.updateMatrixWorld();M.copy(t.matrixWorldInverse);b.multiplyMatrices(t.projectionMatrix,M);O.setFromMatrix(b);r=0;R.objects.length=0;R.lights.length=0;N(e);if(i===true){R.objects.sort(I)}var s=R.objects;for(var p=0,u=s.length;p<u;p++){var v=s[p].object;var d=v.geometry;B.setObject(v);z=v.matrixWorld;o=0;if(v instanceof THREE.Mesh){if(d instanceof THREE.BufferGeometry){var h=d.attributes;var y=d.groups;if(h.position===undefined)continue;var x=h.position.array;for(var g=0,w=x.length;g<w;g+=3){B.pushVertex(x[g],x[g+1],x[g+2])}if(h.normal!==undefined){var S=h.normal.array;for(var g=0,w=S.length;g<w;g+=3){B.pushNormal(S[g],S[g+1],S[g+2])}}if(h.uv!==undefined){var k=h.uv.array;for(var g=0,w=k.length;g<w;g+=2){B.pushUv(k[g],k[g+1])}}if(d.index!==null){var W=d.index.array;if(y.length>0){for(var F=0;F<y.length;F++){var U=y[F];for(var g=U.start,w=U.start+U.count;g<w;g+=3){B.pushTriangle(W[g],W[g+1],W[g+2])}}}else{for(var g=0,w=W.length;g<w;g+=3){B.pushTriangle(W[g],W[g+1],W[g+2])}}}else{for(var g=0,w=x.length/3;g<w;g+=3){B.pushTriangle(g,g+1,g+2)}}}else if(d instanceof THREE.Geometry){var J=d.vertices;var K=d.faces;var Q=d.faceVertexUvs[0];j.getNormalMatrix(z);var X=v.material;var Y=Array.isArray(X);for(var Z=0,$=J.length;Z<$;Z++){var _=J[Z];T.copy(_);if(X.morphTargets===true){var ee=d.morphTargets;var re=v.morphTargetInfluences;for(var te=0,ie=ee.length;te<ie;te++){var ne=re[te];if(ne===0)continue;var oe=ee[te];var ae=oe.vertices[Z];T.x+=(ae.x-_.x)*ne;T.y+=(ae.y-_.y)*ne;T.z+=(ae.z-_.z)*ne}}B.pushVertex(T.x,T.y,T.z)}for(var se=0,le=K.length;se<le;se++){var ce=K[se];X=Y===true?v.material[ce.materialIndex]:v.material;if(X===undefined)continue;var pe=X.side;var ue=a[ce.a];var fe=a[ce.b];var Ee=a[ce.c];if(B.checkTriangleVisibility(ue,fe,Ee)===false)continue;var ve=B.checkBackfaceCulling(ue,fe,Ee);if(pe!==THREE.DoubleSide){if(pe===THREE.FrontSide&&ve===false)continue;if(pe===THREE.BackSide&&ve===true)continue}l=G();l.id=v.id;l.v1.copy(ue);l.v2.copy(fe);l.v3.copy(Ee);l.normalModel.copy(ce.normal);if(ve===false&&(pe===THREE.BackSide||pe===THREE.DoubleSide)){l.normalModel.negate()}l.normalModel.applyMatrix3(j).normalize();var de=ce.vertexNormals;for(var he=0,me=Math.min(de.length,3);he<me;he++){var ye=l.vertexNormalsModel[he];ye.copy(de[he]);if(ve===false&&(pe===THREE.BackSide||pe===THREE.DoubleSide)){ye.negate()}ye.applyMatrix3(j).normalize()}l.vertexNormalsLength=de.length;var xe=Q[se];if(xe!==undefined){for(var Re=0;Re<3;Re++){l.uvs[Re].copy(xe[Re])}}l.color=ce.color;l.material=X;l.z=(ue.positionScreen.z+fe.positionScreen.z+Ee.positionScreen.z)/3;l.renderOrder=v.renderOrder;R.elements.push(l)}}}else if(v instanceof THREE.Line){V.multiplyMatrices(b,z);if(d instanceof THREE.BufferGeometry){var h=d.attributes;if(h.position!==undefined){var x=h.position.array;for(var g=0,w=x.length;g<w;g+=3){B.pushVertex(x[g],x[g+1],x[g+2])}if(h.color!==undefined){var Te=h.color.array;for(var g=0,w=Te.length;g<w;g+=3){B.pushColor(Te[g],Te[g+1],Te[g+2])}}if(d.index!==null){var W=d.index.array;for(var g=0,w=W.length;g<w;g+=2){B.pushLine(W[g],W[g+1])}}else{var He=v instanceof THREE.LineSegments?2:1;for(var g=0,w=x.length/3-1;g<w;g+=He){B.pushLine(g,g+1)}}}}else if(d instanceof THREE.Geometry){var J=v.geometry.vertices;if(J.length===0)continue;ue=P();ue.positionScreen.copy(J[0]).applyMatrix4(V);var He=v instanceof THREE.LineSegments?2:1;for(var Z=1,$=J.length;Z<$;Z++){ue=P();ue.positionScreen.copy(J[Z]).applyMatrix4(V);if((Z+1)%He>0)continue;fe=a[o-2];C.copy(ue.positionScreen);L.copy(fe.positionScreen);if(q(C,L)===true){C.multiplyScalar(1/C.w);L.multiplyScalar(1/L.w);f=D();f.id=v.id;f.v1.positionScreen.copy(C);f.v2.positionScreen.copy(L);f.z=Math.max(C.z,L.z);f.renderOrder=v.renderOrder;f.material=v.material;if(v.material.vertexColors===THREE.VertexColors){f.vertexColors[0].copy(v.geometry.colors[Z]);f.vertexColors[1].copy(v.geometry.colors[Z-1])}R.elements.push(f)}}}}else if(v instanceof THREE.Points){V.multiplyMatrices(b,z);if(d instanceof THREE.Geometry){var J=v.geometry.vertices;for(var Z=0,$=J.length;Z<$;Z++){var _=J[Z];H.set(_.x,_.y,_.z,1);H.applyMatrix4(V);A(H,v,t)}}else if(d instanceof THREE.BufferGeometry){var h=d.attributes;if(h.position!==undefined){var x=h.position.array;for(var g=0,w=x.length;g<w;g+=3){H.set(x[g],x[g+1],x[g+2],1);H.applyMatrix4(V);A(H,v,t)}}}}else if(v instanceof THREE.Sprite){H.set(z.elements[12],z.elements[13],z.elements[14],1);H.applyMatrix4(b);A(H,v,t)}}if(n===true){R.elements.sort(I)}return R};function A(e,r,t){var i=1/e.w;e.z*=i;if(e.z>=-1&&e.z<=1){h=U();h.id=r.id;h.x=e.x*i;h.y=e.y*i;h.z=e.z;h.renderOrder=r.renderOrder;h.object=r;h.rotation=r.rotation;h.scale.x=r.scale.x*Math.abs(h.x-(e.x+t.projectionMatrix.elements[0])/(e.w+t.projectionMatrix.elements[12]));h.scale.y=r.scale.y*Math.abs(h.y-(e.y+t.projectionMatrix.elements[5])/(e.w+t.projectionMatrix.elements[13]));h.material=r.material;R.elements.push(h)}}function F(){if(r===i){var e=new THREE.RenderableObject;t.push(e);i++;r++;return e}return t[r++]}function P(){if(o===s){var e=new THREE.RenderableVertex;a.push(e);s++;o++;return e}return a[o++]}function G(){if(c===u){var e=new THREE.RenderableFace;p.push(e);u++;c++;return e}return p[c++]}function D(){if(E===d){var e=new THREE.RenderableLine;v.push(e);d++;E++;return e}return v[E++]}function U(){if(m===x){var e=new THREE.RenderableSprite;y.push(e);x++;m++;return e}return y[m++]}function I(e,r){if(e.renderOrder!==r.renderOrder){return e.renderOrder-r.renderOrder}else if(e.z!==r.z){return r.z-e.z}else if(e.id!==r.id){return e.id-r.id}else{return 0}}function q(e,r){var t=0,i=1,n=e.z+e.w,o=r.z+r.w,a=-e.z+e.w,s=-r.z+r.w;if(n>=0&&o>=0&&a>=0&&s>=0){return true}else if(n<0&&o<0||a<0&&s<0){return false}else{if(n<0){t=Math.max(t,n/(n-o))}else if(o<0){i=Math.min(i,n/(n-o))}if(a<0){t=Math.max(t,a/(a-s))}else if(s<0){i=Math.min(i,a/(a-s))}if(i<t){return false}else{e.lerp(r,t);r.lerp(e,1-i);return true}}}};